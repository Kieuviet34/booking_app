{% extends "base.html" %}
{% block title %}Quản lý nhân viên{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Quản lý nhân viên</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('staff_bp.add_staff') }}" class="btn btn-primary">
            <span data-feather="plus"></span> Thêm nhân viên
        </a>
    </div>
</div>

<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm nhân viên...">
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover" id="staffTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Địa chỉ</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            {% if staffs|length > 0 %}
                {% for staff in staffs %}
                    <tr>
                        <td>{{ staff.id }}</td>
                        <td>{{ staff.full_name }}</td>
                        <td>{{ staff.email }}</td>
                        <td>{{ staff.phone }}</td>
                        <td>{{ staff.address }}</td>
                        <td>
                          {% if staff.status == 'active' %}
                            <span class="badge bg-success">Hoạt động</span>
                          {% else %}
                            <span class="badge bg-secondary">Không hoạt động</span>
                          {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('staff_bp.edit_staff', id=staff.id) }}" class="btn btn-sm btn-warning">
                                <span data-feather="edit"></span> Sửa
                            </a>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="{{ staff.id }}">
                                <span data-feather="trash-2"></span> Xóa
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center">Không có nhân viên nào.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Live search: lọc các hàng của bảng theo input
    document.getElementById('searchInput').addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#staffTable tbody tr');
      rows.forEach(row => {
          const cells = row.getElementsByTagName('td');
          let match = false;
          // Duyệt qua các cột (trừ cột Thao tác cuối cùng)
          for (let i = 0; i < cells.length - 1; i++) {
              if (cells[i].textContent.toLowerCase().indexOf(filter) > -1) {
                  match = true;
                  break;
              }
          }
          row.style.display = match ? '' : 'none';
      });
    });

    // Xử lý xóa nhân viên bằng AJAX và reload lại trang sau khi xóa thành công
    document.querySelectorAll('.btn-delete').forEach(button => {
      button.addEventListener('click', function() {
        if (!confirm('Bạn có chắc chắn muốn xóa nhân viên này không?')) {
          return;
        }
        const staffId = this.getAttribute('data-id');
        fetch(`/staff/delete/${staffId}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              location.reload();
            } else {
              alert('Xóa nhân viên thất bại.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi xóa.');
          });
      });
    });
  </script>
{% endblock %}
