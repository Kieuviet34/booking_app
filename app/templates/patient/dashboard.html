{% extends "base.html" %}
{% block title %}Quản lý bệnh nhân{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Quản lý bệnh nhân</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('patient_bp.add_patient') }}" class="btn btn-primary">
            <span data-feather="plus"></span> Thêm bệnh nhân
        </a>
    </div>
</div>

<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm bệnh nhân...">
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover" id="patientsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Địa chỉ</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            {% if patients|length > 0 %}
                {% for patient in patients %}
                    <tr>
                        <td>{{ patient.id }}</td>
                        <td>{{ patient.name }}</td>
                        <td>{{ patient.email }}</td>
                        <td>{{ patient.phone }}</td>
                        <td>{{ patient.address }}</td>
                        <td>
                            <a href="{{ url_for('patient_bp.edit_patient', id=patient.id) }}" class="btn btn-sm btn-warning">
                                <span data-feather="edit"></span> Sửa
                            </a>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="{{ patient.id }}">
                                <span data-feather="trash-2"></span> Xóa
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" class="text-center">Không có bệnh nhân nào.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.getElementById('searchInput').addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#patientsTable tbody tr');
      rows.forEach(row => {
          const cells = row.getElementsByTagName('td');
          let match = false;
          for (let i = 0; i < cells.length - 1; i++) {
              if (cells[i].textContent.toLowerCase().indexOf(filter) > -1) {
                  match = true;
                  break;
              }
          }
          row.style.display = match ? '' : 'none';
      });
    });

    document.querySelectorAll('.btn-delete').forEach(button => {
      button.addEventListener('click', function() {
        if (!confirm('Bạn có chắc chắn muốn xóa bệnh nhân này không?')) {
          return;
        }
        const patientId = this.getAttribute('data-id');
        fetch(`/patient/delete/${patientId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            location.reload();
          } else {
            alert('Xóa bệnh nhân thất bại.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi xóa.');
        });
      });
    });
  </script>
{% endblock %}
